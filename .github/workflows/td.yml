name: TD

on:
  push:
    branches: [ "test/github-extensions-td-eas" ]
    paths:
      - .github/workflows/td.yml

jobs:
  build:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0
          bundler-cache: true
      
      - name: Decode the keys
        env:
          AC_SAMPLE_JKS_BASE64: ${{ secrets.AC_SAMPLE_JKS }}
          KEYSTORE_PROPERTIES: ${{ vars.KEYSTORE_PROPERTIES }}
          # DOT_ENV: ${{ vars.DOT_ENV }}
        run: |
          # create variables
          mkdir -p $GITHUB_WORKSPACE/keystore
          JKS_PATH=$GITHUB_WORKSPACE/keystore/ac-sample.jks
          PROPERTIES_PATH=$GITHUB_WORKSPACE/keystore/keystore.properties
          
          # write to file
          echo -n "$AC_SAMPLE_JKS_BASE64" | base64 --decode > $JKS_PATH
          echo -n "$KEYSTORE_PROPERTIES" > $PROPERTIES_PATH

      - name: Debug Env.
        run: |
          echo "$RUNNER_TEMP"
          ls $RUNNER_TEMP
          echo "$GITHUB_WORKSPACE"
          ls $GITHUB_WORKSPACE
          
      - name: Build
        run: |
          echo $AC_PP_UUID
          bundle exec fastlane android build_signed

      - name: Appcircle Testing Distribution
        # uses: appcircleio/appcircle-testing-distribution-githubaction@v0.0.2
        uses: appcircleio/appcircle-testing-distribution-githubaction@feat/SP-201
        env:
          # ACCESS_TOKEN: ${{ secrets.AC_ACCESS_TOKEN }}
          # PROFILE_NAME: ${{ vars.AC_PROFILE_NAME }}
          # CREATE_PROFILE_IF_NOT_EXISTS: ${{ vars.AC_CREATE_PROFILE_IF_NOT_EXISTS }}
          APP_PATH: ${{ github.workspace }}/app/build/outputs/apk/release/app-release.apk
        with:
          accessToken: ${{ secrets.AC_ACCESS_TOKEN }}
          profileName: ${{ vars.AC_PROFILE_NAME }}
          createProfileIfNotExists: false # $CREATE_PROFILE_IF_NOT_EXISTS
          appPath: $APP_PATH
          message: "Hello from Github to TD"

      
